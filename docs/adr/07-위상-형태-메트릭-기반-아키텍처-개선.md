
# 아키텍처 개선 계획: 위상-형태-메트릭 접근법 도입

## 맥락

성능 분석을 통해 파악한 기존 방식의 두 가지 주요 문제점은 다음과 같습니다.

1. **초기 위치 결정 방식:**
- 기존엔 노드와 그룹을 우선 랜덤하게 배치하고, 이를 퍼뜨리고 빈공간을 줄이는 방식으로 **초기 위치**를 결정했습니다.  
- 이로 인하여 노드 간의 상대적 위치 관계가 완전히 무시되었고, 노드 간의 엣지 교차 최소화가 불가능했습니다.

<br/>

2. **성능 문제:**
- `A-Star` 그리드 기반 탐색의 성능 및 품질 한계를 극복하고자 `Bus-Channel` 및 `Vertices-Network` 전략을 도입했습니다. 
- 그러나 성능 분석 결과, 두 전략 모두 사전 계산된 네트워크(채널, 가시성 그래프) 자체는 효율적이었으나, 각 엣지가 이 네트워크로 진입/진출하는 지점(`Ramp`)을 찾는 과정에서 심각한 성능 병목이 발생함이 확인되었습니다.
- 특히, **모든 포트**와 모든 채널/정점의 조합을 탐색하는 방식으로 구현되어, 그래프의 복잡도가 증가함에 따라 **기하급수적인 성능 저하(의사 다항 시간, Pseudo Polynomial Time 복잡도)** 를 유발했습니다.

이러한 문제를 근본적으로 해결하기 위해, 아래와 같은 3단계 파이프라인을 도입하여 아키텍처를 개선하고자 합니다.

<h3 align='center' >

**위상(Topology) → 형태(Shape) → 메트릭(Metrics)** 

</h3>

처음부터 완전히 재설계하기 보다, 이미 존재하는 `Placement`, `Routing`, `Post-Process` 3단계 구조에 새로운 단계별 아키텍처를 녹여내는 방식부터 시도해보고자 합니다.   
이미 `Placement` 단계에서 위상과 메트릭의 일부 개념을 사용하고 있었으므로, 기존 자산을 최대한 활용하여 전환할 수 있을 것으로 예상됩니다. 

<br/>

**파이프라인 재정의 및 고도화 계획**

| **제안된 3단계** | **현재 대응 단계(모듈)** | **현재 모듈 기능** | **새로운 모듈/고도화 기능** |
| :------------: | :--------------: | :--------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1. 위상 (Topology)** | 배치 (`initialPlacement`)| 노드와 그룹을 **랜덤**하게 격자 기반으로 초기 배치 | **계층 할당 (`Ranking`):** 그래프의 방향성을 분석하여 노드의 수직적 계층을 결정 <br/> **교차 최소화 (`Ordering`):** 동일 계층 내 노드 순서를 최적화하여 엣지 교차를 최소화 <br/> **가상 노드 삽입:** 긴 엣지를 분할하여 굴절점을 표현할 가상 노드를 추가 |
| **2. 형태 (Shape)** | 라우팅 (`routeAll`, `routeOnVisibilityGraph`), 포트 할당 (`assignPorts`)) | **모든 포트**/정점 조합을 탐색하여 최적 경로를 계산하고, 포트를 할당 | **포트 '결정' 로직:** 위상 단계에서 결정된 상대 위치를 기반으로 연결할 포트의 면(`Side`)을 논리적으로 결정 **(기존 완전 탐색 제거‼️)** <br/> **직교화:** 가상 노드를 실제 엣지 굴절점(`bend point`)으로 변환하여 경로 형태 구체화 |
| **3. 메트릭 (Metrics)** | 다듬기 (`resolveOverlap`, `sweepCompact`, `finalizePaths`, `beautifyPath`) | 노드 겹침 해소, 여백 압축, 최종 경로 정리 | **좌표 할당:** 위상/형태 단계에서 결정된 추상적 레이아웃에 실제 (`x`, `y`) 좌표를 부여 <br/> **길이 최소화 및 압축:** 기존 압축 로직을 활용하여 전체 레이아웃의 면적을 최소화 |

<br/>

---

<br/>

## 결정

아래는 새로운 3단계 파이프라인을 구현하기 위한 커다란 틀에서의 실행 계획 초안입니다.

### 1. 위상 (Topology) - 상대적 위치 결정

이 단계의 목표는 노드의 절대 좌표가 아닌, 그래프의 구조적 뼈대(상대적 순서 및 계층)를 확정하는 것입니다.

#### 1) 계층 할당 (Ranking)
- '가장 긴 경로 찾기(`Longest Path`)' 알고리즘과 유사한 방식으로 그래프의 모든 노드에 대해 수직적 계층(`Rank`)을 할당합니다.
- `Rank`를 여러 개 가로지르는 긴 엣지는 각 `Rank`를 통과하도록 **가상 노드(`Dummy Node`)** 를 삽입하여 분할합니다. 이는 이후 엣지 굴절점으로 사용됩니다.

#### 2) 교차 최소화 (`Crossing Reduction`)
- 각 계층 내 노드들의 수평적 순서를 결정하여 엣지 교차를 최소화합니다.
- **'무게중심(`Barycenter`) 휴리스틱'** 을 적용합니다. 특정 계층의 노드를 정렬할 때, 연결된 상위(또는 하위) 계층 노드들의 위치값 평균을 기준으로 정렬합니다.
- 이 과정을 상향(`Top-down`) 및 하향(`Bottom-up`)으로 여러 번 반복(`Sweep`)하여 안정적인 순서를 찾습니다.

- **반환값:** 각 노드의 (`Rank`, `Intra-rank Position`) 쌍. 예: `Node A` = (`Rank 0`, `Position 1`).

<br/>
<br/>

### 2. 형태 (Shape) - 경로 및 포트 형태 결정

이 단계의 목표는 위상 단계의 추상적 결과를 바탕으로 경로의 꺾임과 포트 연결 방향을 구체화하는 것입니다.

#### 1) 포트 할당 (`Port Assignment`)

- 기존의 기하학적 탐색 방식을 폐기합니다.
- 위상 단계에서 결정된 노드 간의 상대 위치(예: `A`는 `B`의 상위 계층)를 기반으로 연결할 포트의 **면(`Side`)을 논리적으로 결정**합니다. (예: `A`의 `bottom`면, `B`의 `top`면)
- 이를 통해 `findBestRamp`, `findRampInfo`와 같은 병목 함수를 완전히 제거합니다.

#### 2) 직교화 (`Orthogonalization`)
- 위상 단계에서 삽입된 가상 노드를 실제 엣지의 **굴절점(`bend point`)** 으로 해석합니다.
- 노드-가상노드-노드로 이어지는 경로를 수평/수직 세그먼트의 연속으로 변환하여 엣지의 구체적인 형태를 결정합니다.

- **반환값:** 각 노드에 할당된 포트 정보, 각 엣지의 굴절점 리스트.

<br/>
<br/>

### 3. 메트릭 (Metrics) - 최종 좌표 할당

이 단계의 목표는 모든 요소에 실제 크기와 (`x`, `y`) 좌표를 부여하여 최종 레이아웃을 완성하는 것입니다.

#### 1) 좌표 할당 (`Coordinate Assignment`)
- **Y 좌표 할당:** 각 `Rank`(계층)에 순차적으로 `Y` 좌표를 부여합니다. 계층의 높이는 해당 `Rank`에서 가장 큰 노드의 높이를 기준으로 설정합니다.
- **X 좌표 할당:** 각 `Rank` 내에서 교차 최소화 단계에서 결정된 순서에 따라 노드들을 배치합니다. 이때, 연결된 노드들과의 엣지 길이를 줄이는 방향으로 `X` 좌표를 미세 조정합니다.

#### 2) 압축 및 후처리 (`Compaction & Post-Processing`)
- 모든 요소의 좌표가 할당된 후, 기존의 `sweepCompact`와 같은 압축 알고리즘을 적용하여 불필요한 여백을 최소화하고 레이아웃 면적을 줄입니다.
- `finalizePaths`, `beautifyPath` 등의 후처리 로직을 적용하여 동일 경로를 공유하는 엣지들을 분리(차선 할당)하고 최종 경로를 다듬습니다.

- **반환값:** 모든 노드, 엣지 경로, 굴절점의 최종 (`x`, `y`) 좌표.


<br/>
<br/>

## 예상 결과

1.  **성능 측면:**
    -   `findBestRamp`, `findRampInfo` 등 포트 기반의 기하학적 완전 탐색 로직이 제거되어, `Bus-Channel` 및 `Vertices-Network` 전략의 핵심 성능 문제가 개선될 것으로 기대됩니다.

2.  **노드 증가에 대한 확장성 측면:**
    *   그래프의 위상적 구조를 먼저 해석하고 이에 기반해 기하학적 형태와 좌표를 결정하는 방식으로 변경되므로, 노드 및 엣지 수 증가에 따른 성능 저하가 기존 방식보다 훨씬 완만해질 것입니다.

3.  **레이아웃 품질 및 예측 가능성 향상:**
    *   계층 구조와 교차 최소화 단계를 명시적으로 수행함으로써, 보다 정돈되고 예측 가능한 고품질의 레이아웃 결과를 안정적으로 생성할 수 있습니다.